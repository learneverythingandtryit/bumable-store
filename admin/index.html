<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - BUMABLE</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .admin-header {
            background: #000000;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .admin-header h1 {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-nav {
            display: flex;
            gap: 20px;
        }

        .admin-nav a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .admin-nav a:hover,
        .admin-nav a.active {
            background: #333333;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .stats-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 2rem;
        }

        .stat-card {
            flex: 1;
            min-width: 200px;
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .stat-card.orders { color: #007bff; }
        .stat-card.revenue { color: #28a745; }
        .stat-card.customers { color: #fd7e14; }
        .stat-card.products { color: #6f42c1; }

        .admin-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .section-header {
            background: #000000;
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .section-content {
            padding: 1.5rem;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .orders-table th,
        .orders-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            position: relative;
        }

        .orders-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .orders-table tr:hover {
            background: #f8f9fa;
        }

        /* Ensure table container doesn't cut off dropdowns */
        .table-container {
            overflow: visible;
            position: relative;
        }

        .orders-table tbody tr {
            position: relative;
        }

        /* ===== POPUP MODAL STYLES ===== */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .popup-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        .popup-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            animation: slideIn 0.3s ease-out;
        }

        .popup-header {
            background: #097969;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .popup-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .popup-body {
            padding: 25px;
        }

        .popup-body p {
            margin-bottom: 15px;
            color: #555;
        }

        .status-options {
            margin-top: 25px;
        }

        .status-options label {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: block;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .status-option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .status-option:hover {
            border-color: #097969;
            background: #f8fff8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(9, 121, 105, 0.2);
        }

        .status-option i {
            font-size: 1.2rem;
            color: #097969;
        }

        .status-option.status-danger {
            border-color: #dc3545;
        }

        .status-option.status-danger:hover {
            border-color: #dc3545;
            background: #fff5f5;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);
        }

        .status-option.status-danger i {
            color: #dc3545;
        }

        .popup-footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: right;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-primary {
            background: #097969;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: #075d54;
        }

        .selected-status {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #097969;
        }

        .status-option.selected {
            border-color: #097969;
            background: #f8fff8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(9, 121, 105, 0.2);
        }

        /* ===== TAB SYSTEM ===== */
        .customer-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-size: 1rem;
            color: #6c757d;
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            color: #097969;
        }

        .tab-btn.active {
            color: #097969;
            font-weight: 600;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #097969;
            border-radius: 2px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .notification-badge {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ===== CONTACT QUERIES ===== */
        .query-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: box-shadow 0.2s ease;
        }

        .query-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .query-header {
            background: #f8f9fa;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .query-info h4 {
            margin: 0;
            color: #333;
            font-size: 1.1rem;
        }

        .query-info p {
            margin: 0.25rem 0 0 0;
            color: #666;
            font-size: 0.9rem;
        }

        .query-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-new { color: #007bff; }
        .status-replied { color: #28a745; }

        .query-body {
            padding: 1.5rem;
        }

        .query-message {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            border-left: 4px solid #097969;
            margin-bottom: 1rem;
            font-style: italic;
        }

        .query-reply {
            background: #e8f5e8;
            padding: 1rem;
            border-radius: 5px;
            border-left: 4px solid #28a745;
            margin-top: 1rem;
        }

        .query-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to { 
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-confirmed { background: #d4edda; color: #155724; }
        .status-processing { background: #fff3cd; color: #856404; }
        .status-shipped { background: #cce5ff; color: #004085; }
        .status-delivered { background: #d1ecf1; color: #0c5460; }
        .status-cancelled { background: #f8d7da; color: #721c24; }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-right: 5px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }

        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Dropdown Actions */
        .actions-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
        }

        .dropdown-toggle:hover {
            background: #5a6268;
        }

        .dropdown-toggle.btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .dropdown-toggle.btn-warning:hover {
            background: #e0a800;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            min-width: 180px;
            z-index: 9999;
            display: none;
            overflow: hidden;
            margin-top: 5px;
        }

        .dropdown-menu.show {
            display: block;
            animation: dropdownFadeIn 0.2s ease-out;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
            color: #097969;
        }

        .dropdown-item i {
            font-size: 0.85rem;
            width: 16px;
        }

        .dropdown-item.text-danger {
            color: #dc3545;
        }

        .dropdown-item.text-danger:hover {
            background: #fff5f5;
            color: #dc3545;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75rem;
            margin-left: 5px;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #555;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .no-orders {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .stats-grid {
                flex-direction: column;
            }
            
            .stat-card {
                min-width: 100%;
            }
        }

        @media (max-width: 480px) {
            .admin-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .admin-nav {
                justify-content: center;
                flex-wrap: wrap;
            }

            .admin-container {
                padding: 1rem;
            }

            .stats-grid {
                flex-direction: column;
            }
            
            .stat-card {
                min-width: 100%;
            }

            .orders-table {
                font-size: 0.8rem;
            }

            .filters {
                flex-direction: column;
            }
        }

        .customer-info {
            font-size: 0.85rem;
            color: #666;
        }

        .order-total {
            font-weight: 600;
            color: #28a745;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: #007bff;
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }

        .modal-body {
            padding: 20px;
        }

        /* Order Summary Styles */
        .order-summary {
            font-family: 'Poppins', sans-serif;
        }

        .order-summary-header {
            text-align: center;
            border-bottom: 2px solid #097969;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .order-summary-header h2 {
            color: #097969;
            margin: 0;
            font-size: 24px;
        }

        .order-summary-header .company-info {
            margin-top: 5px;
            color: #666;
            font-size: 14px;
        }

        .summary-section {
            margin-bottom: 20px;
        }

        .summary-section h3 {
            color: #097969;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 5px 0;
        }

        .summary-row.total {
            border-top: 1px solid #ddd;
            font-weight: bold;
            font-size: 18px;
            margin-top: 10px;
            padding-top: 10px;
        }

        .order-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .order-items-table th,
        .order-items-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .order-items-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #097969;
        }

        .download-pdf-btn {
            background: #097969;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            font-size: 16px;
        }

        .download-pdf-btn:hover {
            background: #075f52;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
    </style>
</head>
<body>
    <!-- Admin Header -->
    <header class="admin-header">
        <h1>BUMABLE Admin</h1>
        <nav class="admin-nav">
            <a href="javascript:void(0)" class="active" onclick="showSection('dashboard')">Dashboard</a>
            <a href="javascript:void(0)" onclick="showSection('orders')">Orders</a>
            <a href="javascript:void(0)" onclick="showSection('products')">Products</a>
            <a href="javascript:void(0)" onclick="showSection('customers')">Customers</a>
            <a href="../">Back to Store</a>
            <a href="#" onclick="logout()" style="background: #dc3545;">
                Logout
            </a>
        </nav>
    </header>

    <div class="admin-container">
        <!-- Dashboard Stats -->
        <div id="dashboard" class="admin-section">
            <div class="section-header">
                <h2><i class="fas fa-chart-bar"></i> Dashboard Overview</h2>
                <span id="last-updated">Last updated: Loading...</span>
            </div>
            <div class="section-content">
                <div class="stats-grid">
                    <div class="stat-card orders">
                        <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
                        <div class="stat-value" id="total-orders">0</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card revenue">
                        <div class="stat-icon"><i class="fas fa-rupee-sign"></i></div>
                        <div class="stat-value" id="total-revenue">₹0</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-card customers">
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-value" id="total-customers">0</div>
                        <div class="stat-label">Total Customers</div>
                    </div>
                    <div class="stat-card products">
                        <div class="stat-icon"><i class="fas fa-box"></i></div>
                        <div class="stat-value" id="total-products">12</div>
                        <div class="stat-label">Products in Stock</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Management -->
        <div id="orders" class="admin-section" style="display: none;">
            <div class="section-header">
                <h2><i class="fas fa-list"></i> Order Management</h2>
                <div>
                    <button class="action-btn btn-primary" onclick="refreshOrders()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="action-btn btn-warning" onclick="exportOrdersData()" title="Export Orders to CSV">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            <div class="section-content">
                <!-- Filters -->
                <div class="filters">
                    <div class="filter-group">
                        <label>Status Filter</label>
                        <select id="admin-status-filter" onchange="filterAdminOrders()">
                            <option value="all">All Orders</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="processing">Processing</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Date From</label>
                        <input type="date" id="admin-date-from" onchange="filterAdminOrders()">
                    </div>
                    <div class="filter-group">
                        <label>Date To</label>
                        <input type="date" id="admin-date-to" onchange="filterAdminOrders()">
                    </div>
                </div>

                <!-- Orders Table -->
                <div class="table-container" style="overflow-x: auto;">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Payment</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-orders-tbody">
                            <tr>
                                <td colspan="8" class="no-orders">Loading orders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Products Management -->
        <div id="products" class="admin-section" style="display: none;">
            <div class="section-header">
                <h2><i class="fas fa-box"></i> Product Management</h2>
                <div>
                    <button class="action-btn btn-success" onclick="showAddProductForm()">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                    <button class="action-btn btn-primary" onclick="forceSyncProducts()">
                        <i class="fas fa-sync-alt"></i> Sync
                    </button>
                    <button class="action-btn btn-warning" onclick="adminExportProducts()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            <div class="section-content">
                <!-- Product Stats -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card" style="color: #28a745;">
                        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-value" id="products-in-stock">0</div>
                        <div class="stat-label">In Stock</div>
                    </div>
                    <div class="stat-card" style="color: #ffc107;">
                        <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="stat-value" id="products-low-stock">0</div>
                        <div class="stat-label">Low Stock</div>
                    </div>
                    <div class="stat-card" style="color: #dc3545;">
                        <div class="stat-icon"><i class="fas fa-times-circle"></i></div>
                        <div class="stat-value" id="products-out-stock">0</div>
                        <div class="stat-label">Out of Stock</div>
                    </div>
                    <div class="stat-card" style="color: #17a2b8;">
                        <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="stat-value" id="products-on-sale">0</div>
                        <div class="stat-label">On Sale</div>
                    </div>
                </div>

                <!-- Products Table -->
                <div style="overflow-x: auto;">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Product Name</th>
                                <th>Category</th>
                                <th>Regular Price</th>
                                <th>Sale Price</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-products-tbody">
                            <tr>
                                <td colspan="8" class="no-orders">Loading products...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Customers Management -->
        <div id="customers" class="admin-section" style="display: none;">
            <div class="section-header">
                <h2><i class="fas fa-users"></i> Customer Management</h2>
                <div>
                    <button class="action-btn btn-primary" onclick="refreshCustomersData()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="action-btn btn-warning" onclick="exportCustomersData()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            <div class="section-content">
                <!-- Customer Tabs -->
                <div class="customer-tabs">
                    <button class="tab-btn active" onclick="showCustomerTab('customers-list')">
                        <i class="fas fa-users"></i> Customers
                    </button>
                    <button class="tab-btn" onclick="showCustomerTab('contact-queries')">
                        <i class="fas fa-comment-dots"></i> Contact Queries
                        <span id="new-queries-badge" class="notification-badge" style="display: none;">0</span>
                    </button>
                </div>

                <!-- Customer Statistics -->
                <div id="customer-statistics" class="stats-grid" style="margin-bottom: 2rem; display: flex;">
                    <div class="stat-card" style="color: #007bff;">
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-value" id="customers-total">0</div>
                        <div class="stat-label">Total Customers</div>
                    </div>
                    <div class="stat-card" style="color: #28a745;">
                        <div class="stat-icon"><i class="fas fa-user-plus"></i></div>
                        <div class="stat-value" id="customers-new">0</div>
                        <div class="stat-label">New This Month</div>
                    </div>
                    <div class="stat-card" style="color: #ffc107;">
                        <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
                        <div class="stat-value" id="customers-orders">0</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card" style="color: #17a2b8;">
                        <div class="stat-icon"><i class="fas fa-rupee-sign"></i></div>
                        <div class="stat-value" id="customers-value">₹0</div>
                        <div class="stat-label">Total Value</div>
                    </div>
                </div>

                <!-- Customers List Tab -->
                <div id="customers-list" class="tab-content active">
                    <h3 style="margin-bottom: 1rem;">Customer List</h3>
                    <div style="overflow-x: auto;">
                        <table class="orders-table">
                            <thead>
                                <tr>
                                    <th>Customer Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Orders</th>
                                    <th>Total Spent</th>
                                    <th>Last Order</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-customers-tbody">
                                <tr>
                                    <td colspan="7" class="no-orders">Loading customers...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Contact Queries Tab -->
                <div id="contact-queries" class="tab-content" style="display: none;">
                    <h3 style="margin-bottom: 1rem;">Contact Queries</h3>
                    
                    <!-- Contact Queries Statistics -->
                    <div class="stats-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card" style="color: #007bff;">
                            <div class="stat-icon"><i class="fas fa-envelope"></i></div>
                            <div class="stat-value" id="queries-total">0</div>
                            <div class="stat-label">Total Queries</div>
                        </div>
                        <div class="stat-card" style="color: #ffc107;">
                            <div class="stat-icon"><i class="fas fa-clock"></i></div>
                            <div class="stat-value" id="queries-pending">0</div>
                            <div class="stat-label">Pending Replies</div>
                        </div>
                        <div class="stat-card" style="color: #28a745;">
                            <div class="stat-icon"><i class="fas fa-reply"></i></div>
                            <div class="stat-value" id="queries-replied">0</div>
                            <div class="stat-label">Replied Queries</div>
                        </div>
                        <div class="stat-card" style="color: #17a2b8;">
                            <div class="stat-icon"><i class="fas fa-calendar-day"></i></div>
                            <div class="stat-value" id="queries-today">0</div>
                            <div class="stat-label">Queries Today</div>
                        </div>
                    </div>
                    
                    <div id="queries-list">
                        <!-- Contact queries will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Query Reply Modal -->
        <div id="reply-modal" class="popup-overlay">
            <div class="popup-content">
                <div class="popup-header">
                    <h3><i class="fas fa-reply"></i> Reply to Query</h3>
                    <button class="close-btn" onclick="closeReplyModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="popup-body">
                    <div class="query-details">
                        <p><strong>Customer:</strong> <span id="reply-customer-name"></span></p>
                        <p><strong>Email:</strong> <span id="reply-customer-email"></span></p>
                        <p><strong>Original Message:</strong></p>
                        <div id="reply-original-message" style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin: 0.5rem 0;"></div>
                    </div>
                    <div class="reply-form">
                        <label for="admin-reply">Your Reply:</label>
                        <textarea id="admin-reply" rows="5" placeholder="Type your reply here..." style="width: 100%; margin-top: 0.5rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                    </div>
                </div>
                <div class="popup-footer">
                    <button class="btn-secondary" onclick="closeReplyModal()">Cancel</button>
                    <button class="btn-primary" onclick="sendReply()">Send Reply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load products.js for synchronization -->
    <script src="js/products.js"></script>
    
    <script>
        let allAdminOrders = [];

        // Initialize admin dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication first
            if (!checkAdminAuthentication()) {
                return; // Redirected to login
            }
            
            loadAdminData();
            updateLastUpdated();
            
            // Initialize product sync
            initializeProductSync();
            
            // Show dashboard by default
            showSection('dashboard');
        });

        // Check admin authentication
        function checkAdminAuthentication() {
            const adminSession = localStorage.getItem('bumableAdminSession');
            
            if (!adminSession) {
                redirectToLogin('No session found. Please login.');
                return false;
            }
            
            try {
                const session = JSON.parse(adminSession);
                const now = new Date().getTime();
                
                if (session.expires <= now) {
                    localStorage.removeItem('bumableAdminSession');
                    redirectToLogin('Session expired. Please login again.');
                    return false;
                }
                
                // Update header with admin info
                updateAdminHeader(session);
                return true;
                
            } catch (e) {
                localStorage.removeItem('bumableAdminSession');
                redirectToLogin('Invalid session. Please login again.');
                return false;
            }
        }

        // Redirect to login page
        function redirectToLogin(message) {
            alert(message);
            window.location.href = '../login/';
        }

        // Update admin header with session info
        function updateAdminHeader(session) {
            const headerTitle = document.querySelector('.admin-header h1');
            if (headerTitle) {
                headerTitle.innerHTML = `${session.username}`;
            }
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('bumableAdminSession');
                alert('Logged out successfully!');
                window.location.href = 'admin-login.html';
            }
        }

        // Load all admin data
        function loadAdminData() {
            loadDashboardStats();
            loadAdminOrders();
            loadAdminProducts(); // Add this line
            loadContactQueries(); // Add contact queries loading
        }

        // Load dashboard statistics
        function loadDashboardStats() {
            try {
                const orders = JSON.parse(localStorage.getItem('bumableOrders')) || [];
                const customers = JSON.parse(localStorage.getItem('bumableCustomers')) || [];
                
                // Calculate stats
                const totalOrders = orders.length;
                const totalRevenue = orders.reduce((sum, order) => sum + (order.total || 0), 0);
                const totalCustomers = customers.length;
                
                // Update dashboard
                document.getElementById('total-orders').textContent = totalOrders;
                document.getElementById('total-revenue').textContent = `₹${totalRevenue.toLocaleString('en-IN')}`;
                document.getElementById('total-customers').textContent = totalCustomers;
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        // Load orders for admin management
        function loadAdminOrders() {
            try {
                allAdminOrders = JSON.parse(localStorage.getItem('bumableOrders')) || [];
                displayAdminOrders(allAdminOrders);
            } catch (error) {
                console.error('Error loading admin orders:', error);
                allAdminOrders = [];
                displayAdminOrders([]);
            }
        }

        // Display orders in admin table
        function displayAdminOrders(orders) {
            const tbody = document.getElementById('admin-orders-tbody');
            
            if (!orders || orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-orders">No orders found</td></tr>';
                return;
            }

            // Sort by date (newest first)
            orders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

            tbody.innerHTML = orders.map(order => createAdminOrderRow(order)).join('');
        }

        // Create admin order table row
        function createAdminOrderRow(order) {
            const orderDate = new Date(order.orderDate).toLocaleDateString('en-IN');
            const statusClass = `status-${(order.status || 'confirmed').toLowerCase()}`;
            const statusText = order.status || 'Confirmed';
            
            const itemsCount = order.items ? order.items.length : 0;
            const itemsText = itemsCount === 1 ? '1 item' : `${itemsCount} items`;
            
            const customerName = order.firstName && order.lastName 
                ? `${order.firstName} ${order.lastName}` 
                : 'N/A';
            
            return `
                <tr>
                    <td><strong>${order.orderId}</strong></td>
                    <td>
                        <div>${customerName}</div>
                        <div class="customer-info">${order.email || ''}</div>
                        <div class="customer-info">${order.phone || ''}</div>
                    </td>
                    <td>${orderDate}</td>
                    <td>${itemsText}</td>
                    <td class="order-total">₹${order.total.toLocaleString('en-IN')}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${order.payment || 'COD'}</td>
                    <td>
                        <button class="action-btn btn-primary" onclick="viewOrderSummary('${order.orderId}')" title="Order Summary">
                            <i class="fas fa-file-alt"></i>
                        </button>
                        <button class="action-btn btn-warning" onclick="openStatusPopup('${order.orderId}', '${order.status || 'pending'}')" title="Update Status">
                            <i class="fas fa-edit"></i>
                            Status
                        </button>
                        <button class="action-btn btn-danger" onclick="deleteOrder('${order.orderId}')" title="Delete Order">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        // Filter admin orders
        function filterAdminOrders() {
            const statusFilter = document.getElementById('admin-status-filter').value;
            const dateFrom = document.getElementById('admin-date-from').value;
            const dateTo = document.getElementById('admin-date-to').value;

            let filteredOrders = [...allAdminOrders];

            // Filter by status
            if (statusFilter !== 'all') {
                filteredOrders = filteredOrders.filter(order => 
                    (order.status || 'confirmed').toLowerCase() === statusFilter
                );
            }

            // Filter by date range
            if (dateFrom) {
                filteredOrders = filteredOrders.filter(order => 
                    new Date(order.orderDate) >= new Date(dateFrom)
                );
            }

            if (dateTo) {
                filteredOrders = filteredOrders.filter(order => 
                    new Date(order.orderDate) <= new Date(dateTo)
                );
            }

            displayAdminOrders(filteredOrders);
        }

        // View order summary with PDF download option
        function viewOrderSummary(orderId) {
            const order = allAdminOrders.find(o => o.orderId === orderId);
            if (!order) {
                alert('Order not found!');
                return;
            }

            const customerName = `${order.firstName || ''} ${order.lastName || ''}`.trim() || 'N/A';
            const customerEmail = order.email || 'N/A';
            const customerPhone = order.phone || 'N/A';
            
            const address = order.address1 
                ? `${order.address1}${order.address2 ? ', ' + order.address2 : ''}, ${order.city || ''}, ${order.state || ''} ${order.zipCode || ''}`
                : 'N/A';

            const orderDate = new Date(order.orderDate).toLocaleDateString('en-IN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const itemsTableRows = order.items.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.size || 'M'}</td>
                    <td>${item.quantity}</td>
                    <td>₹${item.price.toLocaleString('en-IN')}</td>
                    <td>₹${(item.price * item.quantity).toLocaleString('en-IN')}</td>
                </tr>
            `).join('');

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'order-summary-modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; width: 95%;">
                    <div class="modal-header">
                        <h3>Order Summary</h3>
                        <button type="button" class="modal-close" onclick="closeOrderSummary()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="order-summary" id="order-summary-content">
                            <div class="order-summary-header">
                                <h2>BUMABLE</h2>
                                <div class="company-info">Premium Clothing Store</div>
                                <div class="company-info">Order Summary</div>
                            </div>

                            <div class="summary-section">
                                <h3>Order Information</h3>
                                <div class="summary-row">
                                    <span><strong>Order ID:</strong></span>
                                    <span>${order.orderId}</span>
                                </div>
                                <div class="summary-row">
                                    <span><strong>Order Date:</strong></span>
                                    <span>${orderDate}</span>
                                </div>
                                <div class="summary-row">
                                    <span><strong>Status:</strong></span>
                                    <span><span class="status-badge status-${(order.status || 'confirmed').toLowerCase()}">${order.status || 'Confirmed'}</span></span>
                                </div>
                                <div class="summary-row">
                                    <span><strong>Payment Method:</strong></span>
                                    <span>${order.payment || 'Cash on Delivery'}</span>
                                </div>
                            </div>

                            <div class="summary-section">
                                <h3>Customer Details</h3>
                                <div class="summary-row">
                                    <span><strong>Name:</strong></span>
                                    <span>${customerName}</span>
                                </div>
                                <div class="summary-row">
                                    <span><strong>Email:</strong></span>
                                    <span>${customerEmail}</span>
                                </div>
                                <div class="summary-row">
                                    <span><strong>Phone:</strong></span>
                                    <span>${customerPhone}</span>
                                </div>
                                <div class="summary-row">
                                    <span><strong>Delivery Address:</strong></span>
                                    <span>${address}</span>
                                </div>
                            </div>

                            <div class="summary-section">
                                <h3>Order Items</h3>
                                <table class="order-items-table">
                                    <thead>
                                        <tr>
                                            <th>Product</th>
                                            <th>Size</th>
                                            <th>Qty</th>
                                            <th>Price</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${itemsTableRows}
                                    </tbody>
                                </table>
                            </div>

                            <div class="summary-section">
                                <h3>Order Total</h3>
                                <div class="summary-row">
                                    <span>Subtotal:</span>
                                    <span>₹${order.subtotal.toLocaleString('en-IN')}</span>
                                </div>
                                <div class="summary-row">
                                    <span>GST (18%):</span>
                                    <span>₹${order.tax.toLocaleString('en-IN')}</span>
                                </div>
                                <div class="summary-row total">
                                    <span>Grand Total:</span>
                                    <span>₹${order.total.toLocaleString('en-IN')}</span>
                                </div>
                            </div>

                            <button class="download-pdf-btn" onclick="downloadOrderPDF('${orderId}')">
                                <i class="fas fa-download"></i> Download PDF
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Close order summary modal
        function closeOrderSummary() {
            const modal = document.getElementById('order-summary-modal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // Download order summary as PDF
        function downloadOrderPDF(orderId) {
            const order = allAdminOrders.find(o => o.orderId === orderId);
            if (!order) {
                alert('Order not found!');
                return;
            }

            // Create a new window for PDF generation
            const printWindow = window.open('', '_blank', 'width=800,height=1000');
            const customerName = `${order.firstName || ''} ${order.lastName || ''}`.trim() || 'N/A';
            const address = order.address1 
                ? `${order.address1}${order.address2 ? ', ' + order.address2 : ''}, ${order.city || ''}, ${order.state || ''} ${order.zipCode || ''}`
                : 'N/A';

            const orderDate = new Date(order.orderDate).toLocaleDateString('en-IN', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const itemsTableRows = order.items.map(item => `
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">${item.name}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: center;">${item.size || 'M'}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: center;">${item.quantity}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">₹${item.price.toLocaleString('en-IN')}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">₹${(item.price * item.quantity).toLocaleString('en-IN')}</td>
                </tr>
            `).join('');

            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Order Summary - ${orderId}</title>
                    <style>
                        body { font-family: 'Poppins', sans-serif; margin: 20px; color: #333; line-height: 1.6; }
                        .header { text-align: center; border-bottom: 2px solid #097969; padding-bottom: 15px; margin-bottom: 20px; }
                        .header h1 { color: #097969; margin: 0; font-size: 28px; }
                        .header .company-info { margin-top: 5px; color: #666; font-size: 14px; }
                        .section { margin-bottom: 20px; }
                        .section h2 { color: #097969; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 10px; font-size: 18px; }
                        .info-row { display: flex; justify-content: space-between; margin-bottom: 5px; padding: 5px 0; }
                        .total-row { border-top: 1px solid #ddd; font-weight: bold; font-size: 18px; margin-top: 10px; padding-top: 10px; }
                        .items-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                        .items-table th { background-color: #f8f9fa; font-weight: bold; color: #097969; padding: 10px 8px; border-bottom: 2px solid #097969; }
                        .items-table td { padding: 8px; border-bottom: 1px solid #ddd; }
                        .status-badge { padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 500; text-transform: uppercase; }
                        .status-confirmed { background: #d4edda; color: #155724; }
                        .status-processing { background: #fff3cd; color: #856404; }
                        .status-shipped { background: #cce5ff; color: #004085; }
                        .status-delivered { background: #d1ecf1; color: #0c5460; }
                        .status-cancelled { background: #f8d7da; color: #721c24; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>BUMABLE</h1>
                        <div class="company-info">Premium Clothing Store</div>
                        <div class="company-info">Order Summary</div>
                    </div>

                    <div class="section">
                        <h2>Order Information</h2>
                        <div class="info-row">
                            <span><strong>Order ID:</strong></span>
                            <span>${order.orderId}</span>
                        </div>
                        <div class="info-row">
                            <span><strong>Order Date:</strong></span>
                            <span>${orderDate}</span>
                        </div>
                        <div class="info-row">
                            <span><strong>Status:</strong></span>
                            <span><span class="status-badge status-${(order.status || 'confirmed').toLowerCase()}">${order.status || 'Confirmed'}</span></span>
                        </div>
                        <div class="info-row">
                            <span><strong>Payment Method:</strong></span>
                            <span>${order.payment || 'Cash on Delivery'}</span>
                        </div>
                    </div>

                    <div class="section">
                        <h2>Customer Details</h2>
                        <div class="info-row">
                            <span><strong>Name:</strong></span>
                            <span>${customerName}</span>
                        </div>
                        <div class="info-row">
                            <span><strong>Email:</strong></span>
                            <span>${order.email || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span><strong>Phone:</strong></span>
                            <span>${order.phone || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span><strong>Delivery Address:</strong></span>
                            <span>${address}</span>
                        </div>
                    </div>

                    <div class="section">
                        <h2>Order Items</h2>
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th style="text-align: left;">Product</th>
                                    <th style="text-align: center;">Size</th>
                                    <th style="text-align: center;">Qty</th>
                                    <th style="text-align: right;">Price</th>
                                    <th style="text-align: right;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsTableRows}
                            </tbody>
                        </table>
                    </div>

                    <div class="section">
                        <h2>Order Total</h2>
                        <div class="info-row">
                            <span>Subtotal:</span>
                            <span>₹${order.subtotal.toLocaleString('en-IN')}</span>
                        </div>
                        <div class="info-row">
                            <span>GST (18%):</span>
                            <span>₹${order.tax.toLocaleString('en-IN')}</span>
                        </div>
                        <div class="info-row total-row">
                            <span><strong>Grand Total:</strong></span>
                            <span><strong>₹${order.total.toLocaleString('en-IN')}</strong></span>
                        </div>
                    </div>

                    <scr` + `ipt>
                        window.onload = function() {
                            window.print();
                            window.onafterprint = function() {
                                window.close();
                            };
                        };
                    </scr` + `ipt>
                </body>
                </html>
            `;

            printWindow.document.write(printContent);
            printWindow.document.close();
        }

        // View order details
        function viewOrderDetails(orderId) {
            const order = allAdminOrders.find(o => o.orderId === orderId);
            if (!order) return;

            const itemsList = order.items.map(item => 
                `• ${item.name} (Size: ${item.size || 'M'}, Qty: ${item.quantity}) - ₹${(item.price * item.quantity).toLocaleString('en-IN')}`
            ).join('\n');

            const address = order.address1 
                ? `${order.address1}${order.address2 ? ', ' + order.address2 : ''}, ${order.city || ''}, ${order.state || ''} ${order.zipCode || ''}`
                : 'N/A';

            alert(`Order Details - ${orderId}

Customer: ${order.firstName || ''} ${order.lastName || ''}
Email: ${order.email || 'N/A'}
Phone: ${order.phone || 'N/A'}
Address: ${address}

Items:
${itemsList}

Subtotal: ₹${order.subtotal.toLocaleString('en-IN')}
Tax (GST): ₹${order.tax.toLocaleString('en-IN')}
Total: ₹${order.total.toLocaleString('en-IN')}

Payment Method: ${order.payment || 'Cash on Delivery'}
Status: ${order.status || 'Confirmed'}
Order Date: ${new Date(order.orderDate).toLocaleString('en-IN')}`);
        }

        // Update order status
        function updateOrderStatus(orderId) {
            const order = allAdminOrders.find(o => o.orderId === orderId);
            if (!order) return;

            const newStatus = prompt(`Update status for order ${orderId}:

Current Status: ${order.status || 'Confirmed'}

Enter new status (confirmed/processing/shipped/delivered/cancelled):`, order.status || 'confirmed');

            if (newStatus && ['confirmed', 'processing', 'shipped', 'delivered', 'cancelled'].includes(newStatus.toLowerCase())) {
                order.status = newStatus.toLowerCase();
                
                // Save updated orders
                localStorage.setItem('bumableOrders', JSON.stringify(allAdminOrders));
                
                // Refresh display
                loadAdminData();
                
                alert(`Order ${orderId} status updated to: ${newStatus}`);
            }
        }

        // Update order status to specific status (from dropdown)
        function updateOrderStatusTo(orderId, newStatus) {
            const order = allAdminOrders.find(o => o.orderId === orderId);
            if (!order) return;

            // Confirm the status change
            const statusLabels = {
                'confirmed': 'Confirmed',
                'processing': 'Processing', 
                'shipped': 'Shipped',
                'delivered': 'Delivered',
                'cancelled': 'Cancelled'
            };

            if (confirm(`Change order ${orderId} status to "${statusLabels[newStatus]}"?`)) {
                order.status = newStatus;
                
                // Save updated orders
                localStorage.setItem('bumableOrders', JSON.stringify(allAdminOrders));
                
                // Refresh display
                loadAdminData();
                
                alert(`Order ${orderId} status updated to: ${statusLabels[newStatus]}`);
            }

            // Close any open dropdowns
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.style.display = 'none';
            });
        }

        // Cancel order
        function cancelOrder(orderId) {
            if (confirm(`Are you sure you want to cancel order ${orderId}?`)) {
                const order = allAdminOrders.find(o => o.orderId === orderId);
                if (order) {
                    order.status = 'cancelled';
                    localStorage.setItem('bumableOrders', JSON.stringify(allAdminOrders));
                    loadAdminData();
                    alert(`Order ${orderId} has been cancelled.`);
                }
            }
        }

        // Refresh orders
        function refreshOrders() {
            loadAdminData();
            updateLastUpdated();
            alert('Data refreshed successfully!');
        }

        // Show specific section
        function showSection(sectionName) {
            console.log('Switching to section:', sectionName);
            
            // Update nav active state
            document.querySelectorAll('.admin-nav a').forEach(link => {
                link.classList.remove('active');
            });
            
            // Find and activate the clicked nav link
            const navLinks = document.querySelectorAll('.admin-nav a');
            navLinks.forEach(link => {
                const onclick = link.getAttribute('onclick');
                if (onclick && onclick.includes(`'${sectionName}'`)) {
                    link.classList.add('active');
                }
            });
            
            // Hide all sections
            const sections = ['dashboard', 'orders', 'products', 'customers'];
            sections.forEach(section => {
                const element = document.getElementById(section);
                if (element) {
                    element.style.display = 'none';
                    console.log('Hiding section:', section);
                }
            });
            
            // Show the requested section
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.style.display = 'block';
                console.log('Showing section:', sectionName);
                
                // Load data for specific sections
                if (sectionName === 'products') {
                    console.log('Loading products...');
                    loadAdminProducts();
                } else if (sectionName === 'orders') {
                    console.log('Loading orders...');
                    loadAdminOrders();
                } else if (sectionName === 'customers') {
                    console.log('Loading customers...');
                    loadCustomersData();
                } else if (sectionName === 'dashboard') {
                    console.log('Loading dashboard...');
                    loadAdminData();
                }
            } else {
                console.error('Section not found:', sectionName);
            }
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            document.getElementById('last-updated').textContent = 
                `Last updated: ${new Date().toLocaleTimeString('en-IN')}`;
        }

        // ===== PRODUCT SYNCHRONIZATION FUNCTIONS =====
        
        // Initialize product synchronization
        function initializeProductSync() {
            console.log('Initializing product sync...');
            
            if (window.productManager) {
                console.log('Product Manager loaded successfully');
                console.log('Number of products:', window.productManager.getAllProducts().length);
                updateProductStats();
                
                // Listen for storage changes to sync with main site
                window.addEventListener('storage', function(e) {
                    if (e.key === 'bumable_products') {
                        console.log('Products updated from main site, syncing admin...');
                        if (window.productManager) {
                            // Reload products from storage
                            window.productManager = new ProductManager();
                            updateProductStats();
                            loadAdminProducts();
                        }
                    }
                });
            } else {
                console.error('Product Manager not loaded. Retrying...');
                setTimeout(initializeProductSync, 500);
            }
        }

        // Update product statistics
        function updateProductStats() {
            if (!window.productManager) return;
            
            const products = window.productManager.getAllProducts();
            const inStockCount = products.filter(p => p.inStock && p.stockCount > 0).length;
            const lowStockCount = products.filter(p => p.stockCount <= 10 && p.stockCount > 0).length;
            const outOfStockCount = products.filter(p => !p.inStock || p.stockCount === 0).length;
            const onSaleCount = products.filter(p => p.onSale).length;
            
            // Update main dashboard product count
            document.getElementById('total-products').textContent = products.length;
            
            // Update product management stats
            document.getElementById('products-in-stock').textContent = inStockCount;
            document.getElementById('products-low-stock').textContent = lowStockCount;
            document.getElementById('products-out-stock').textContent = outOfStockCount;
            document.getElementById('products-on-sale').textContent = onSaleCount;
            
            console.log('Product stats updated:', {
                total: products.length,
                inStock: inStockCount,
                lowStock: lowStockCount,
                outOfStock: outOfStockCount,
                onSale: onSaleCount
            });
        }

        // Load admin products
        function loadAdminProducts() {
            console.log('Loading admin products...');
            
            if (!window.productManager) {
                console.log('Product manager not ready, retrying...');
                setTimeout(loadAdminProducts, 500);
                return;
            }
            
            console.log('Product manager is ready');
            updateProductStats();
            displayAdminProducts();
        }

        // Display products in admin table
        function displayAdminProducts() {
            console.log('Displaying admin products...');
            
            if (!window.productManager) {
                console.log('No product manager available');
                return;
            }
            
            const products = window.productManager.getAllProducts();
            console.log('Products to display:', products.length, products);
            
            const tbody = document.getElementById('admin-products-tbody');
            
            if (!tbody) {
                console.error('Product table body not found');
                return;
            }
            
            if (!products || products.length === 0) {
                console.log('No products found, showing empty message');
                tbody.innerHTML = '<tr><td colspan="8" class="no-orders">No products found</td></tr>';
                return;
            }

            console.log('Creating product rows...');
            tbody.innerHTML = products.map(product => createAdminProductRow(product)).join('');
            console.log('Products displayed successfully');
        }

        // Create admin product table row
        function createAdminProductRow(product) {
            const stockStatus = product.stockCount <= 0 ? 'Out of Stock' : 
                               product.stockCount <= 10 ? 'Low Stock' : 'In Stock';
            const stockClass = product.stockCount <= 0 ? 'status-cancelled' : 
                              product.stockCount <= 10 ? 'status-processing' : 'status-confirmed';
            
            return `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            ${product.images && Array.isArray(product.images) ? 
                                '<img src="' + product.images[0] + '" alt="' + product.name + '" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;" onerror="this.src=\'images/placeholder-product.svg\'">' :
                                '<img src="' + product.image + '" alt="' + product.name + '" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;" onerror="this.src=\'images/placeholder-product.svg\'">'
                            }
                        </div>
                    </td>
                    <td>
                        <strong>${product.name}</strong>
                        <div class="customer-info">${product.description}</div>
                    </td>
                    <td>${product.category}</td>
                    <td>
                        <input type="number" value="${product.regularPrice}" min="0" step="0.01" 
                               onchange="quickUpdatePrice('${product.id}', this.value, true)"
                               style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 3px;">
                    </td>
                    <td>
                        <input type="number" value="${product.salePrice || ''}" min="0" step="0.01" 
                               placeholder="No sale"
                               onchange="quickUpdateSalePrice('${product.id}', this.value)"
                               style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 3px;">
                        ${product.onSale ? '<span class="status-badge status-confirmed" style="margin-left: 5px;">SALE</span>' : ''}
                    </td>
                    <td>
                        <input type="number" value="${product.stockCount}" min="0" 
                               onchange="quickUpdateStock('${product.id}', this.value)"
                               style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 3px;">
                    </td>
                    <td>
                        <span class="status-badge ${stockClass}">${stockStatus}</span>
                    </td>
                    <td>
                        <button class="action-btn btn-primary" onclick="editProductDetails('${product.id}')" title="Edit Details">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn btn-warning" onclick="toggleProductSale('${product.id}')" title="Toggle Sale">
                            <i class="fas fa-tag"></i>
                        </button>
                        <button class="action-btn btn-danger" onclick="deleteProductConfirm('${product.id}')" title="Delete Product">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        // Quick update functions
        function quickUpdatePrice(productId, newPrice, isRegular = true) {
            const price = parseFloat(newPrice);
            if (isNaN(price) || price < 0) {
                alert('Please enter a valid price');
                loadAdminProducts(); // Reload to reset
                return;
            }
            
            const updates = isRegular ? { regularPrice: price } : { salePrice: price };
            
            if (adminUpdateProduct(productId, updates)) {
                console.log(`Updated ${isRegular ? 'regular' : 'sale'} price for ${productId}: ₹${price}`);
            } else {
                alert('Failed to update price');
                loadAdminProducts();
            }
        }

        function quickUpdateSalePrice(productId, newPrice) {
            if (newPrice === '' || newPrice == '0') {
                // Remove sale
                adminUpdateProduct(productId, { salePrice: null, onSale: false });
            } else {
                const price = parseFloat(newPrice);
                if (isNaN(price) || price < 0) {
                    alert('Please enter a valid sale price');
                    loadAdminProducts();
                    return;
                }
                adminUpdateProduct(productId, { salePrice: price, onSale: true });
            }
            loadAdminProducts();
        }

        function quickUpdateStock(productId, newStock) {
            const stock = parseInt(newStock);
            if (isNaN(stock) || stock < 0) {
                alert('Please enter a valid stock quantity');
                loadAdminProducts();
                return;
            }
            
            if (adminUpdateProductStock(productId, stock)) {
                console.log(`Updated stock for ${productId}: ${stock}`);
                loadAdminProducts();
            } else {
                alert('Failed to update stock');
                loadAdminProducts();
            }
        }

        function toggleProductSale(productId) {
            const product = window.productManager.getProduct(productId);
            if (!product) return;
            
            const newSaleStatus = !product.onSale;
            
            if (newSaleStatus && !product.salePrice) {
                const salePrice = prompt(`Enter sale price for ${product.name}:`, Math.floor(product.regularPrice * 0.8));
                if (salePrice && !isNaN(parseFloat(salePrice))) {
                    adminUpdateProduct(productId, { 
                        salePrice: parseFloat(salePrice), 
                        onSale: true 
                    });
                    loadAdminProducts();
                }
            } else {
                adminUpdateProduct(productId, { onSale: newSaleStatus });
                loadAdminProducts();
            }
        }

        function deleteProductConfirm(productId) {
            const product = window.productManager.getProduct(productId);
            if (!product) return;
            
            if (confirm(`Are you sure you want to delete "${product.name}"?\n\nThis action cannot be undone.`)) {
                if (adminDeleteProduct(productId)) {
                    alert('Product deleted successfully!');
                    loadAdminProducts();
                } else {
                    alert('Failed to delete product');
                }
            }
        }

        function editProductDetails(productId) {
            const product = window.productManager.getProduct(productId);
            if (!product) {
                alert('Product not found');
                return;
            }
            
            // Create comprehensive edit form
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; width: 90%;">
                    <div class="modal-header">
                        <h3><i class="fas fa-edit"></i> Edit Product: ${product.name}</h3>
                        <button type="button" class="modal-close" onclick="closeProductModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="edit-product-form" onsubmit="saveEditedProduct(event, '${productId}')">
                            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label for="edit-product-name">Product Name *</label>
                                    <input type="text" id="edit-product-name" name="name" value="${product.name}" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-product-category">Category *</label>
                                    <select id="edit-product-category" name="category" required>
                                        <option value="">Select Category</option>
                                        <option value="briefs" ${product.category === 'briefs' ? 'selected' : ''}>Briefs</option>
                                        <option value="trunks" ${product.category === 'trunks' ? 'selected' : ''}>Trunks</option>
                                        <option value="tie-dye" ${product.category === 'tie-dye' ? 'selected' : ''}>Tie-Dye</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="edit-product-regular-price">Regular Price (₹) *</label>
                                    <input type="number" id="edit-product-regular-price" name="regularPrice" min="0" step="0.01" value="${product.regularPrice}" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-product-sale-price">Sale Price (₹)</label>
                                    <input type="number" id="edit-product-sale-price" name="salePrice" min="0" step="0.01" value="${product.salePrice || ''}">
                                </div>
                                <div class="form-group">
                                    <label for="edit-product-stock">Stock Count *</label>
                                    <input type="number" id="edit-product-stock" name="stockCount" min="0" value="${product.stockCount}" required>
                                </div>
                                <div class="form-group">
                                    <label>Available Sizes</label>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 5px;">
                                        <label><input type="checkbox" name="sizes" value="S" ${product.availableSizes && product.availableSizes.includes('S') ? 'checked' : ''}> S</label>
                                        <label><input type="checkbox" name="sizes" value="M" ${product.availableSizes && product.availableSizes.includes('M') ? 'checked' : ''}> M</label>
                                        <label><input type="checkbox" name="sizes" value="L" ${product.availableSizes && product.availableSizes.includes('L') ? 'checked' : ''}> L</label>
                                        <label><input type="checkbox" name="sizes" value="XL" ${product.availableSizes && product.availableSizes.includes('XL') ? 'checked' : ''}> XL</label>
                                        <label><input type="checkbox" name="sizes" value="XXL" ${product.availableSizes && product.availableSizes.includes('XXL') ? 'checked' : ''}> XXL</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top: 15px;">
                                <label for="edit-product-description">Description</label>
                                <textarea id="edit-product-description" name="description" rows="3" placeholder="Enter product description...">${product.description || ''}</textarea>
                            </div>
                            
                            <!-- Current Images Display -->
                            <div class="form-group" style="margin-top: 15px;">
                                <label>Product Images</label>
                                <div id="current-images-display" style="margin-top: 10px;">
                                    <div id="existing-images" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
                                        ${product.images ? product.images.map((img, index) => `
                                            <div class="image-item" style="position: relative; display: inline-block;">
                                                <img src="${img}" alt="${product.name} ${index + 1}" style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onerror="this.src='../images/placeholder-product.svg'">
                                                <button type="button" onclick="removeExistingImage(${index})" style="position: absolute; top: -5px; right: -5px; width: 25px; height: 25px; background: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px;">×</button>
                                                ${index === 0 ? '<span style="position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">Main</span>' : ''}
                                            </div>
                                        `).join('') : `
                                            <div class="image-item" style="position: relative; display: inline-block;">
                                                <img src="${product.image}" alt="${product.name}" style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onerror="this.src='../images/placeholder-product.svg'">
                                                <span style="position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">Main</span>
                                            </div>
                                        `}
                                    </div>
                                    <button type="button" onclick="enableImageEdit()" style="padding: 5px 10px; background: #ffc107; color: #212529; border: none; border-radius: 4px; cursor: pointer;">
                                        <i class="fas fa-plus"></i> Add More Images
                                    </button>
                                </div>
                            </div>
                            
                            <!-- New Images Upload Section (Hidden by default) -->
                            <div class="form-group" id="new-image-section" style="margin-top: 15px; display: none;">
                                <label>Upload Product Images</label>
                                <div class="image-upload-container" style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; margin-top: 10px;">
                                    <input type="file" id="edit-product-images" accept="image/*" multiple style="display: none;" onchange="previewEditProductImages(this)">
                                    
                                    <!-- Preview of new images -->
                                    <div id="edit-images-preview" style="margin-bottom: 15px; display: none;">
                                        <h4 style="margin-bottom: 10px; color: #333;">New Images to Add:</h4>
                                        <div id="new-images-grid" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-start; margin-bottom: 15px;"></div>
                                        <div style="text-align: center;">
                                            <button type="button" onclick="addMoreImages()" style="padding: 8px 16px; margin-right: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                                <i class="fas fa-plus"></i> Add More Images
                                            </button>
                                            <button type="button" onclick="removeAllNewImages()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                                <i class="fas fa-trash"></i> Remove All New Images
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Upload placeholder -->
                                    <div id="edit-upload-placeholder" style="text-align: center;">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #666; margin-bottom: 10px;"></i>
                                        <h4 style="margin: 10px 0; color: #333;">Upload Product Images</h4>
                                        <p style="margin: 0; color: #666;">Select multiple images to add to this product</p>
                                        <p style="margin: 5px 0 15px 0; font-size: 0.9rem; color: #999;">Supports JPG, PNG, GIF (Max 5MB each, up to 10 images total)</p>
                                        <button type="button" onclick="document.getElementById('edit-product-images').click()" style="padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
                                            <i class="fas fa-folder-open"></i> Choose Images
                                        </button>
                                    </div>
                                </div>
                                <div style="margin-top: 15px; text-align: center;">
                                    <button type="button" onclick="cancelImageEdit()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        <i class="fas fa-times"></i> Cancel Image Changes
                                    </button>
                                </div>
                            </div>
                            
                            <div class="modal-footer" style="margin-top: 20px; text-align: right;">
                                <button type="button" onclick="closeProductModal()" style="padding: 10px 20px; margin-right: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                                <button type="submit" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Global storage for edit product images
        window.editProductNewImages = [];
        window.editProductRemovedImages = [];

        // Enable image editing
        function enableImageEdit() {
            document.getElementById('current-images-display').style.display = 'none';
            document.getElementById('new-image-section').style.display = 'block';
            // Reset new images array
            window.editProductNewImages = [];
        }

        // Cancel image editing
        function cancelImageEdit() {
            document.getElementById('current-images-display').style.display = 'block';
            document.getElementById('new-image-section').style.display = 'none';
            removeAllNewImages();
            // Reset tracking arrays
            window.editProductNewImages = [];
            window.editProductRemovedImages = [];
        }

        // Preview multiple product images
        function previewEditProductImages(input) {
            if (input.files && input.files.length > 0) {
                const files = Array.from(input.files);
                
                // Limit total images (existing + new) to 10 maximum
                const existingCount = window.editProductNewImages.length;
                if (existingCount + files.length > 10) {
                    alert(`Maximum 10 images allowed. You can add ${10 - existingCount} more images.`);
                    input.value = '';
                    return;
                }
                
                let validFilesCount = 0;
                
                files.forEach((file, index) => {
                    // Validate file size (5MB max)
                    if (file.size > 5 * 1024 * 1024) {
                        alert(`File "${file.name}" is too large. Please choose images smaller than 5MB.`);
                        return;
                    }
                    
                    // Validate file type
                    if (!file.type.match(/^image\/(jpeg|jpg|png|gif)$/)) {
                        alert(`File "${file.name}" is not a valid image. Please select JPG, PNG, or GIF files.`);
                        return;
                    }
                    
                    validFilesCount++;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Add to our global array
                        window.editProductNewImages.push({
                            dataUrl: e.target.result,
                            filename: file.name,
                            id: Date.now() + index // Unique ID
                        });
                        
                        updateNewImagesPreview();
                    };
                    reader.onerror = function() {
                        alert(`Error reading file: ${file.name}`);
                    };
                    reader.readAsDataURL(file);
                });
                
                // Clear the file input
                input.value = '';
            }
        }

        // Update the preview display
        function updateNewImagesPreview() {
            const newImagesGrid = document.getElementById('new-images-grid');
            
            if (window.editProductNewImages.length === 0) {
                document.getElementById('edit-images-preview').style.display = 'none';
                document.getElementById('edit-upload-placeholder').style.display = 'block';
                return;
            }
            
            newImagesGrid.innerHTML = '';
            
            window.editProductNewImages.forEach((imageData, index) => {
                const imageDiv = document.createElement('div');
                imageDiv.style.cssText = 'position: relative; display: inline-block; margin: 5px;';
                imageDiv.innerHTML = `
                    <img src="${imageData.dataUrl}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <button type="button" onclick="removeNewImageByIndex(${index})" style="position: absolute; top: -5px; right: -5px; width: 25px; height: 25px; background: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px;">×</button>
                    <div style="text-align: center; font-size: 10px; margin-top: 5px; color: #666; max-width: 100px; word-wrap: break-word;">${imageData.filename}</div>
                `;
                newImagesGrid.appendChild(imageDiv);
            });
            
            document.getElementById('edit-images-preview').style.display = 'block';
            document.getElementById('edit-upload-placeholder').style.display = 'none';
        }

        // Remove a specific new image by index
        function removeNewImageByIndex(index) {
            if (index >= 0 && index < window.editProductNewImages.length) {
                window.editProductNewImages.splice(index, 1);
                updateNewImagesPreview();
            }
        }

        // Remove all new images
        function removeAllNewImages() {
            window.editProductNewImages = [];
            document.getElementById('edit-product-images').value = '';
            document.getElementById('edit-images-preview').style.display = 'none';
            document.getElementById('edit-upload-placeholder').style.display = 'block';
            document.getElementById('new-images-grid').innerHTML = '';
        }

        // Remove existing image
        function removeExistingImage(index) {
            if (!window.editProductRemovedImages) {
                window.editProductRemovedImages = [];
            }
            window.editProductRemovedImages.push(index);
            
            // Hide the image visually
            event.target.parentElement.style.display = 'none';
        }

        // Add more images without replacing existing selection
        function addMoreImages() {
            document.getElementById('edit-product-images').click();
        }

        // Save edited product
        function saveEditedProduct(event, productId) {
            event.preventDefault();
            
            const form = document.getElementById('edit-product-form');
            const formData = new FormData(form);
            
            // Get selected sizes
            const sizes = Array.from(form.querySelectorAll('input[name="sizes"]:checked')).map(cb => cb.value);
            
            if (sizes.length === 0) {
                alert('Please select at least one size.');
                return;
            }
            
            // Prepare update data
            const updateData = {
                name: formData.get('name'),
                category: formData.get('category'),
                regularPrice: parseFloat(formData.get('regularPrice')),
                stockCount: parseInt(formData.get('stockCount')),
                description: formData.get('description') || '',
                availableSizes: sizes,
                inStock: parseInt(formData.get('stockCount')) > 0
            };
            
            // Handle sale price
            const salePrice = formData.get('salePrice');
            if (salePrice && parseFloat(salePrice) > 0) {
                updateData.salePrice = parseFloat(salePrice);
                updateData.onSale = true;
            } else {
                updateData.salePrice = null;
                updateData.onSale = false;
            }
            
            // Handle image updates
            const hasNewImages = window.editProductNewImages && window.editProductNewImages.length > 0;
            const hasRemovedImages = window.editProductRemovedImages && window.editProductRemovedImages.length > 0;
            const existingProduct = window.productManager.getProduct(productId);
            
            if (hasNewImages || hasRemovedImages) {
                console.log('Processing image updates...', {
                    newImages: window.editProductNewImages.length,
                    removedImages: window.editProductRemovedImages.length
                });
                
                // Start with existing images
                let currentImages = [];
                if (existingProduct.images && Array.isArray(existingProduct.images)) {
                    currentImages = [...existingProduct.images];
                } else if (existingProduct.image) {
                    // Convert single image to array
                    currentImages = [existingProduct.image];
                }
                
                // Remove deleted images (process in reverse order to maintain indices)
                if (window.editProductRemovedImages && window.editProductRemovedImages.length > 0) {
                    const sortedRemoved = [...window.editProductRemovedImages].sort((a, b) => b - a);
                    sortedRemoved.forEach(index => {
                        if (index >= 0 && index < currentImages.length) {
                            currentImages.splice(index, 1);
                        }
                    });
                }
                
                // Add new images
                if (window.editProductNewImages && window.editProductNewImages.length > 0) {
                    const newImageUrls = window.editProductNewImages.map(img => img.dataUrl);
                    currentImages = [...currentImages, ...newImageUrls];
                }
                
                // Update product with final image array
                updateData.images = currentImages;
                updateData.image = currentImages[0] || existingProduct.image; // Set main image as first image
                
                console.log('Final images array:', {
                    totalImages: currentImages.length,
                    firstImage: currentImages[0] ? 'Set' : 'None'
                });
                
                // Save the product
                if (adminUpdateProduct(productId, updateData)) {
                    alert('Product updated successfully!');
                    closeProductModal();
                    loadAdminProducts();
                    
                    // Reset tracking arrays
                    window.editProductNewImages = [];
                    window.editProductRemovedImages = [];
                    
                    // Force trigger storage event
                    setTimeout(() => {
                        window.dispatchEvent(new Event('storage'));
                    }, 100);
                } else {
                    alert('Failed to update product. Please try again.');
                }
            } else {
                console.log('No image changes, updating product without image modifications');
                // Update product without changing images
                if (adminUpdateProduct(productId, updateData)) {
                    alert('Product updated successfully!');
                    closeProductModal();
                    loadAdminProducts();
                } else {
                    alert('Failed to update product. Please try again.');
                }
            }
        }

        function showAddProductForm() {
            // Create a more comprehensive product form with image upload
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; width: 90%;">
                    <div class="modal-header">
                        <h3><i class="fas fa-plus"></i> Add New Product</h3>
                        <button type="button" class="modal-close" onclick="closeProductModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="product-form" onsubmit="saveNewProduct(event)">
                            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label for="product-name">Product Name *</label>
                                    <input type="text" id="product-name" name="name" required>
                                </div>
                                <div class="form-group">
                                    <label for="product-category">Category *</label>
                                    <select id="product-category" name="category" required>
                                        <option value="">Select Category</option>
                                        <option value="briefs">Briefs</option>
                                        <option value="trunks">Trunks</option>
                                        <option value="tie-dye">Tie-Dye</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="product-regular-price">Regular Price (₹) *</label>
                                    <input type="number" id="product-regular-price" name="regularPrice" min="0" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label for="product-sale-price">Sale Price (₹)</label>
                                    <input type="number" id="product-sale-price" name="salePrice" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label for="product-stock">Stock Count *</label>
                                    <input type="number" id="product-stock" name="stockCount" min="0" value="50" required>
                                </div>
                                <div class="form-group">
                                    <label>Available Sizes</label>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 5px;">
                                        <label><input type="checkbox" name="sizes" value="S" checked> S</label>
                                        <label><input type="checkbox" name="sizes" value="M" checked> M</label>
                                        <label><input type="checkbox" name="sizes" value="L" checked> L</label>
                                        <label><input type="checkbox" name="sizes" value="XL" checked> XL</label>
                                        <label><input type="checkbox" name="sizes" value="XXL"> XXL</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top: 15px;">
                                <label for="product-description">Description</label>
                                <textarea id="product-description" name="description" rows="3" placeholder="Enter product description..."></textarea>
                            </div>
                            
                            <!-- Image Upload Section -->
                            <div class="form-group" style="margin-top: 15px;">
                                <label>Product Image</label>
                                <div class="image-upload-container" style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; margin-top: 10px;">
                                    <input type="file" id="product-image" accept="image/*" style="display: none;" onchange="previewProductImage(this)">
                                    <div id="image-preview" style="margin-bottom: 15px; display: none;">
                                        <img id="preview-img" style="max-width: 200px; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <button type="button" onclick="removeImagePreview()" style="display: block; margin: 10px auto; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove Image</button>
                                    </div>
                                    <div id="upload-placeholder">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #666; margin-bottom: 10px;"></i>
                                        <p style="margin: 0; color: #666;">Click to upload product image</p>
                                        <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #999;">Supports JPG, PNG, GIF (Max 5MB)</p>
                                        <button type="button" onclick="document.getElementById('product-image').click()" style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Choose File</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="modal-footer" style="margin-top: 20px; text-align: right;">
                                <button type="button" onclick="closeProductModal()" style="padding: 10px 20px; margin-right: 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                                <button type="submit" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Add Product</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Preview product image
        function previewProductImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Validate file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size too large. Please choose an image smaller than 5MB.');
                    input.value = '';
                    return;
                }
                
                // Validate file type
                if (!file.type.match(/^image\/(jpeg|jpg|png|gif)$/)) {
                    alert('Please select a valid image file (JPG, PNG, or GIF).');
                    input.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('image-preview').style.display = 'block';
                    document.getElementById('upload-placeholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        // Remove image preview
        function removeImagePreview() {
            document.getElementById('product-image').value = '';
            document.getElementById('image-preview').style.display = 'none';
            document.getElementById('upload-placeholder').style.display = 'block';
        }

        // Close product modal
        function closeProductModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        // Save new product
        function saveNewProduct(event) {
            event.preventDefault();
            
            const form = document.getElementById('product-form');
            const formData = new FormData(form);
            
            // Get selected sizes
            const sizes = Array.from(form.querySelectorAll('input[name="sizes"]:checked')).map(cb => cb.value);
            
            if (sizes.length === 0) {
                alert('Please select at least one size.');
                return;
            }
            
            // Get image
            const imageFile = document.getElementById('product-image').files[0];
            let imagePath = '../images/products/default.jpg';
            
            if (imageFile) {
                // In a real app, you'd upload this to a server
                // For now, we'll use a placeholder path based on the filename
                imagePath = `../images/products/${formData.get('category')}/${imageFile.name}`;
            }
            
            const productData = {
                name: formData.get('name'),
                category: formData.get('category'),
                regularPrice: parseFloat(formData.get('regularPrice')),
                salePrice: formData.get('salePrice') ? parseFloat(formData.get('salePrice')) : null,
                stockCount: parseInt(formData.get('stockCount')),
                description: formData.get('description') || '',
                image: imagePath,
                availableSizes: sizes
            };
            
            if (adminAddProduct(productData)) {
                alert('Product added successfully!');
                closeProductModal();
                loadAdminProducts();
            } else {
                alert('Failed to add product. Please try again.');
            }
        }

        // Admin Product Management Functions
        function adminUpdateProduct(productId, updates) {
            if (!window.productManager) {
                alert('Product manager not loaded. Please refresh the page.');
                return false;
            }
            
            const success = window.productManager.updateProduct(productId, updates);
            if (success) {
                updateProductStats();
                
                // Trigger storage event to notify main site
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'bumable_products',
                    newValue: JSON.stringify(window.productManager.getAllProducts())
                }));
                
                console.log('Product updated:', productId, updates);
                return true;
            }
            return false;
        }

        // Update product price from admin
        function adminUpdateProductPrice(productId, newPrice, isRegularPrice = true) {
            const updates = {};
            if (isRegularPrice) {
                updates.regularPrice = parseFloat(newPrice);
            } else {
                updates.salePrice = parseFloat(newPrice);
            }
            
            return adminUpdateProduct(productId, updates);
        }

        // Update product stock from admin
        function adminUpdateProductStock(productId, newStock) {
            const updates = {
                stockCount: parseInt(newStock),
                inStock: parseInt(newStock) > 0
            };
            
            return adminUpdateProduct(productId, updates);
        }

        // Toggle product sale status from admin
        function adminToggleProductSale(productId, onSale) {
            const updates = { onSale: onSale };
            return adminUpdateProduct(productId, updates);
        }

        // Get all products for admin display
        function adminGetAllProducts() {
            if (!window.productManager) return [];
            return window.productManager.getAllProducts();
        }

        // Add new product from admin
        function adminAddProduct(productData) {
            if (!window.productManager) {
                alert('Product manager not loaded. Please refresh the page.');
                return false;
            }
            
            // Generate unique ID
            const id = 'product-' + Date.now();
            const newProduct = {
                id: id,
                name: productData.name,
                regularPrice: parseFloat(productData.regularPrice),
                salePrice: productData.salePrice ? parseFloat(productData.salePrice) : null,
                onSale: !!productData.salePrice,
                image: productData.image || '../images/products/default.jpg',
                category: productData.category,
                description: productData.description,
                inStock: true,
                stockCount: parseInt(productData.stockCount) || 0,
                availableSizes: productData.availableSizes || ['S', 'M', 'L', 'XL']
            };
            
            // Add to product manager
            const products = window.productManager.getAllProducts();
            products.push(newProduct);
            
            // Save to storage
            window.productManager.products = products;
            window.productManager.saveToStorage();
            
            updateProductStats();
            
            // Trigger storage event to notify main site
            window.dispatchEvent(new StorageEvent('storage', {
                key: 'bumable_products',
                newValue: JSON.stringify(products)
            }));
            
            console.log('New product added:', newProduct);
            return true;
        }

        // Delete product from admin
        function adminDeleteProduct(productId) {
            if (!window.productManager) {
                alert('Product manager not loaded. Please refresh the page.');
                return false;
            }
            
            const products = window.productManager.getAllProducts();
            const index = products.findIndex(p => p.id === productId);
            
            if (index !== -1) {
                products.splice(index, 1);
                window.productManager.products = products;
                window.productManager.saveToStorage();
                
                updateProductStats();
                
                // Trigger storage event to notify main site
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'bumable_products',
                    newValue: JSON.stringify(products)
                }));
                
                console.log('Product deleted:', productId);
                return true;
            }
            
            return false;
        }

        // Reset products to defaults from admin
        function adminResetProducts() {
            if (confirm('This will reset all products to default values. Are you sure?')) {
                if (window.productManager) {
                    window.productManager.resetToDefaults();
                    updateProductStats();
                    
                    // Trigger storage event to notify main site
                    window.dispatchEvent(new StorageEvent('storage', {
                        key: 'bumable_products',
                        newValue: JSON.stringify(window.productManager.getAllProducts())
                    }));
                    
                    alert('Products reset to defaults successfully!');
                }
            }
        }

        // Export products data
        function adminExportProducts() {
            if (!window.productManager) return;
            
            const products = window.productManager.getAllProducts();
            const dataStr = JSON.stringify(products, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `bumable-products-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Products exported successfully!');
        }

        // Manual sync function for testing
        function forceSyncProducts() {
            console.log('Force syncing products...');
            
            // Check if ProductManager exists
            if (!window.ProductManager) {
                console.error('ProductManager class not available');
                alert('ProductManager not loaded. Please refresh the page.');
                return;
            }
            
            // Reinitialize product manager
            window.productManager = new ProductManager();
            console.log('Product manager reinitialized');
            console.log('Products found:', window.productManager.getAllProducts().length);
            
            // Update displays
            updateProductStats();
            loadAdminProducts();
            
            // Update main site by triggering storage event
            const products = window.productManager.getAllProducts();
            localStorage.setItem('bumable_products', JSON.stringify(products));
            
            alert(`Products synchronized successfully! Found ${products.length} products.`);
        }
        
        // ===== CUSTOMER MANAGEMENT FUNCTIONS =====
        
        // Load customers data
        function loadCustomersData() {
            console.log('Loading customers data...');
            
            // Get orders to extract customer information
            const orders = JSON.parse(localStorage.getItem('bumableOrders')) || [];
            console.log('Found orders:', orders.length);
            
            // Extract unique customers from orders
            const customerMap = {};
            
            orders.forEach(order => {
                const customerId = order.email || order.phone || order.orderId;
                const customerName = (order.firstName || '') + ' ' + (order.lastName || '');
                
                if (!customerMap[customerId]) {
                    customerMap[customerId] = {
                        id: customerId,
                        name: customerName.trim() || 'Guest Customer',
                        email: order.email || 'N/A',
                        phone: order.phone || 'N/A',
                        orders: 0,
                        totalSpent: 0,
                        firstOrder: order.orderDate,
                        lastOrder: order.orderDate
                    };
                }
                
                // Update customer stats
                customerMap[customerId].orders += 1;
                customerMap[customerId].totalSpent += order.total || 0;
                
                // Update order dates
                if (new Date(order.orderDate) < new Date(customerMap[customerId].firstOrder)) {
                    customerMap[customerId].firstOrder = order.orderDate;
                }
                if (new Date(order.orderDate) > new Date(customerMap[customerId].lastOrder)) {
                    customerMap[customerId].lastOrder = order.orderDate;
                }
            });
            
            const customers = Object.values(customerMap);
            console.log('Processed customers:', customers.length);
            
            // Update customer stats
            updateCustomerStats(customers);
            
            // Display customers
            displayCustomers(customers);
        }
        
        // Update customer statistics
        function updateCustomerStats(customers) {
            // Get contact queries to include in customer count
            const contactQueries = JSON.parse(localStorage.getItem('bumableContactQueries') || '[]');
            
            // Get unique customers from contact queries
            const uniqueContactEmails = [...new Set(contactQueries.map(q => q.email))];
            const contactCustomers = uniqueContactEmails.length;
            
            // Combine order customers and contact customers
            const totalCustomers = Math.max(customers.length, contactCustomers);
            const totalOrders = customers.reduce((sum, c) => sum + c.orders, 0);
            const totalValue = customers.reduce((sum, c) => sum + c.totalSpent, 0);
            
            // Calculate new customers this month (including contact queries)
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            // New order customers this month
            const newOrderCustomers = customers.filter(customer => {
                const firstOrder = new Date(customer.firstOrder);
                return firstOrder.getMonth() === currentMonth && firstOrder.getFullYear() === currentYear;
            }).length;
            
            // New contact customers this month
            const newContactCustomers = contactQueries.filter(query => {
                const queryDate = new Date(query.timestamp);
                return queryDate.getMonth() === currentMonth && queryDate.getFullYear() === currentYear;
            }).length;
            
            const newCustomers = Math.max(newOrderCustomers, newContactCustomers);
            
            // Update UI
            document.getElementById('customers-total').textContent = totalCustomers;
            document.getElementById('customers-new').textContent = newCustomers;
            document.getElementById('customers-orders').textContent = totalOrders;
            document.getElementById('customers-value').textContent = `₹${totalValue.toLocaleString('en-IN')}`;
        }

        // Update contact queries statistics
        function updateQueriesStats() {
            const queries = JSON.parse(localStorage.getItem('bumableContactQueries') || '[]');
            
            // Calculate stats
            const totalQueries = queries.length;
            const pendingQueries = queries.filter(q => q.status === 'new').length;
            const repliedQueries = queries.filter(q => q.status === 'replied').length;
            
            // Calculate queries today
            const today = new Date();
            const todayQueries = queries.filter(query => {
                const queryDate = new Date(query.timestamp);
                return queryDate.toDateString() === today.toDateString();
            }).length;
            
            // Update UI
            document.getElementById('queries-total').textContent = totalQueries;
            document.getElementById('queries-pending').textContent = pendingQueries;
            document.getElementById('queries-replied').textContent = repliedQueries;
            document.getElementById('queries-today').textContent = todayQueries;
        }
        
        // Display customers in table
        function displayCustomers(customers) {
            const tbody = document.getElementById('admin-customers-tbody');
            
            if (!customers || customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-orders">No customers found</td></tr>';
                return;
            }

            // Sort by total spent (highest first)
            customers.sort((a, b) => b.totalSpent - a.totalSpent);

            tbody.innerHTML = customers.map(customer => {
                const lastOrderDate = new Date(customer.lastOrder).toLocaleDateString('en-IN');
                const customerValue = customer.orders > 1 ? 'Repeat' : 'New';
                
                return `
                    <tr>
                        <td>
                            <strong>${customer.name}</strong>
                            <div class="customer-info">${customerValue} Customer</div>
                        </td>
                        <td>${customer.email}</td>
                        <td>${customer.phone}</td>
                        <td>
                            <span class="status-badge status-confirmed">${customer.orders}</span>
                        </td>
                        <td class="order-total">₹${customer.totalSpent.toLocaleString('en-IN')}</td>
                        <td>${lastOrderDate}</td>
                        <td>
                            <button class="action-btn btn-primary" onclick="viewCustomerDetails('${customer.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn btn-success" onclick="viewCustomerOrders('${customer.id}')" title="View Orders">
                                <i class="fas fa-shopping-bag"></i>
                            </button>
                            <button class="action-btn btn-danger" onclick="deleteCustomer('${customer.id}')" title="Delete Customer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // View customer details
        function viewCustomerDetails(customerId) {
            const orders = JSON.parse(localStorage.getItem('bumableOrders')) || [];
            const customerOrders = orders.filter(order => 
                (order.email || order.phone || order.orderId) === customerId
            );
            
            if (customerOrders.length === 0) {
                alert('No customer data found.');
                return;
            }
            
            const customer = customerOrders[0];
            const totalSpent = customerOrders.reduce((sum, order) => sum + (order.total || 0), 0);
            const totalOrders = customerOrders.length;
            const firstOrder = Math.min(...customerOrders.map(o => new Date(o.orderDate)));
            const lastOrder = Math.max(...customerOrders.map(o => new Date(o.orderDate)));
            
            alert(`Customer Details:
            
Name: ${customer.firstName || ''} ${customer.lastName || ''}
Email: ${customer.email || 'N/A'}
Phone: ${customer.phone || 'N/A'}
Address: ${customer.address || 'N/A'}

Order Summary:
Total Orders: ${totalOrders}
Total Spent: ₹${totalSpent.toLocaleString('en-IN')}
First Order: ${new Date(firstOrder).toLocaleDateString('en-IN')}
Last Order: ${new Date(lastOrder).toLocaleDateString('en-IN')}
Customer Type: ${totalOrders > 1 ? 'Repeat Customer' : 'First-time Customer'}`);
        }
        
        // View customer orders
        function viewCustomerOrders(customerId) {
            const orders = JSON.parse(localStorage.getItem('bumableOrders')) || [];
            const customerOrders = orders.filter(order => 
                (order.email || order.phone || order.orderId) === customerId
            );
            
            if (customerOrders.length === 0) {
                alert('No orders found for this customer.');
                return;
            }
            
            const ordersList = customerOrders.map(order => {
                const orderDate = new Date(order.orderDate).toLocaleDateString('en-IN');
                const itemCount = order.items ? order.items.length : 0;
                return `• Order ${order.orderId} - ${orderDate} - ${itemCount} items - ₹${(order.total || 0).toLocaleString('en-IN')}`;
            }).join('\n');
            
            alert(`Customer Orders:\n\n${ordersList}`);
        }
        
        // Refresh customers data
        function refreshCustomersData() {
            loadCustomersData();
            alert('Customer data refreshed!');
        }
        
        // Export customers data
        function exportCustomersData() {
            const orders = JSON.parse(localStorage.getItem('bumableOrders')) || [];
            
            if (orders.length === 0) {
                alert('No customer data to export.');
                return;
            }
            
            // Create CSV content
            const csvHeaders = ['Customer Name', 'Email', 'Phone', 'Orders Count', 'Total Spent', 'First Order', 'Last Order'];
            const customerMap = {};
            
            // Process orders to get customer data
            orders.forEach(order => {
                const customerId = order.email || order.phone || order.orderId;
                const customerName = (order.firstName || '') + ' ' + (order.lastName || '');
                
                if (!customerMap[customerId]) {
                    customerMap[customerId] = {
                        name: customerName.trim() || 'Guest Customer',
                        email: order.email || 'N/A',
                        phone: order.phone || 'N/A',
                        orders: 0,
                        totalSpent: 0,
                        firstOrder: order.orderDate,
                        lastOrder: order.orderDate
                    };
                }
                
                customerMap[customerId].orders += 1;
                customerMap[customerId].totalSpent += order.total || 0;
                
                if (new Date(order.orderDate) < new Date(customerMap[customerId].firstOrder)) {
                    customerMap[customerId].firstOrder = order.orderDate;
                }
                if (new Date(order.orderDate) > new Date(customerMap[customerId].lastOrder)) {
                    customerMap[customerId].lastOrder = order.orderDate;
                }
            });
            
            const customers = Object.values(customerMap);
            
            const csvData = customers.map(customer => [
                customer.name,
                customer.email,
                customer.phone,
                customer.orders,
                customer.totalSpent,
                new Date(customer.firstOrder).toLocaleDateString('en-IN'),
                new Date(customer.lastOrder).toLocaleDateString('en-IN')
            ]);
            
            const csvContent = [csvHeaders, ...csvData]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
            
            // Download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bumable-customers-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Customer data exported successfully!');
        }
        
        // Export Orders Data to CSV
        function exportOrdersData() {
            const orders = JSON.parse(localStorage.getItem('bumableOrders')) || 
                          JSON.parse(localStorage.getItem('orders')) || [];
            
            if (orders.length === 0) {
                alert('No orders data to export.');
                return;
            }
            
            // Create CSV headers
            const csvHeaders = [
                'Order ID',
                'Customer Name', 
                'Email',
                'Phone',
                'Order Date',
                'Status',
                'Items',
                'Total Amount',
                'Payment Method',
                'Address',
                'City',
                'State',
                'Pincode'
            ];
            
            // Process orders data
            const csvData = orders.map(order => [
                order.orderId || 'N/A',
                ((order.firstName || '') + ' ' + (order.lastName || '')).trim() || 'Guest Customer',
                order.email || 'N/A',
                order.phone || 'N/A',
                order.orderDate ? new Date(order.orderDate).toLocaleDateString('en-IN') : 'N/A',
                (order.status || 'pending').toUpperCase(),
                order.items ? order.items.map(item => `${item.name} (Qty: ${item.quantity})`).join('; ') : 'N/A',
                order.total ? `₹${order.total.toLocaleString('en-IN')}` : '₹0',
                order.payment || 'COD',
                order.address || order.deliveryAddress || 'N/A',
                order.city || 'N/A',
                order.state || 'N/A',
                order.pincode || 'N/A'
            ]);
            
            // Create CSV content
            const csvContent = [csvHeaders, ...csvData]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
            
            // Download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bumable-orders-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Orders data exported successfully!');
        }
        
        // ===== CONTACT QUERIES FUNCTIONALITY =====
        
        let currentReplyQueryId = null;
        
        // Tab switching for customers section
        function showCustomerTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
                selectedTab.style.display = 'block';
            }
            
            // Control customer statistics visibility
            const customerStats = document.getElementById('customer-statistics');
            if (customerStats) {
                if (tabName === 'customers-list') {
                    customerStats.style.display = 'flex';
                } else {
                    customerStats.style.display = 'none';
                }
            }
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load specific data based on tab
            if (tabName === 'contact-queries') {
                loadContactQueries();
            } else if (tabName === 'customers-list') {
                loadCustomersData();
            }
        }
        
        // Load contact queries
        function loadContactQueries() {
            console.log('Loading contact queries...');
            const queries = JSON.parse(localStorage.getItem('bumableContactQueries') || '[]');
            console.log('Found queries in localStorage:', queries.length, queries);
            const queriesList = document.getElementById('queries-list');
            
            if (queries.length === 0) {
                queriesList.innerHTML = '<div class="no-orders" style="text-align: center; padding: 2rem;">No contact queries yet</div>';
                updateNewQueriesBadge(0);
                // Update queries statistics
                updateQueriesStats();
                return;
            }
            
            // Sort queries by timestamp (newest first)
            queries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Count new queries
            const newQueries = queries.filter(q => q.status === 'new').length;
            updateNewQueriesBadge(newQueries);
            
            queriesList.innerHTML = queries.map(query => createQueryCard(query)).join('');
            
            // Update contact queries statistics
            updateQueriesStats();
        }
        
        // Refresh customer stats (separate from loading full customer data)
        function refreshCustomerStats() {
            const orders = JSON.parse(localStorage.getItem('bumableOrders')) || [];
            const customerMap = {};
            
            orders.forEach(order => {
                const customerId = order.email || order.phone || order.orderId;
                const customerName = (order.firstName || '') + ' ' + (order.lastName || '');
                
                if (!customerMap[customerId]) {
                    customerMap[customerId] = {
                        id: customerId,
                        name: customerName.trim() || 'Guest Customer',
                        email: order.email || 'N/A',
                        phone: order.phone || 'N/A',
                        orders: 0,
                        totalSpent: 0,
                        firstOrder: order.orderDate,
                        lastOrder: order.orderDate
                    };
                }
                
                customerMap[customerId].orders++;
                customerMap[customerId].totalSpent += parseFloat(order.total) || 0;
                
                if (new Date(order.orderDate) < new Date(customerMap[customerId].firstOrder)) {
                    customerMap[customerId].firstOrder = order.orderDate;
                }
                if (new Date(order.orderDate) > new Date(customerMap[customerId].lastOrder)) {
                    customerMap[customerId].lastOrder = order.orderDate;
                }
            });
            
            const customers = Object.values(customerMap);
            updateCustomerStats(customers);
        }
        
        // Update new queries badge
        function updateNewQueriesBadge(count) {
            const badge = document.getElementById('new-queries-badge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // Create query card HTML
        function createQueryCard(query) {
            const isNew = query.status === 'new';
            const statusIcon = isNew ? 'fas fa-envelope' : 'fas fa-check-circle';
            const statusClass = isNew ? 'status-new' : 'status-replied';
            const statusText = isNew ? 'New' : 'Replied';
            
            return `
                <div class="query-card">
                    <div class="query-header">
                        <div class="query-info">
                            <h4>${query.firstName} ${query.lastName}</h4>
                            <p>${query.email} • ${new Date(query.timestamp).toLocaleDateString('en-IN')} ${new Date(query.timestamp).toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})}</p>
                        </div>
                        <div class="query-status">
                            <i class="${statusIcon} ${statusClass}"></i>
                            <span class="${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    <div class="query-body">
                        <div class="query-message">
                            "${query.message}"
                        </div>
                        ${query.adminReply ? `
                            <div class="query-reply">
                                <strong>Your Reply:</strong><br>
                                ${query.adminReply}
                                <br><small style="color: #666;">Replied on ${new Date(query.replyTimestamp).toLocaleDateString('en-IN')} ${new Date(query.replyTimestamp).toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})}</small>
                            </div>
                        ` : ''}
                        <div class="query-actions">
                            ${!query.adminReply ? `
                                <button class="action-btn btn-primary" onclick="openReplyModal('${query.id}')">
                                    <i class="fas fa-reply"></i> Reply
                                </button>
                            ` : `
                                <button class="action-btn btn-secondary" onclick="openReplyModal('${query.id}')">
                                    <i class="fas fa-edit"></i> Edit Reply
                                </button>
                            `}
                            <button class="action-btn btn-danger" onclick="deleteQuery('${query.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Open reply modal
        function openReplyModal(queryId) {
            const queries = JSON.parse(localStorage.getItem('bumableContactQueries') || '[]');
            const query = queries.find(q => q.id === queryId);
            
            if (!query) return;
            
            currentReplyQueryId = queryId;
            
            document.getElementById('reply-customer-name').textContent = `${query.firstName} ${query.lastName}`;
            document.getElementById('reply-customer-email').textContent = query.email;
            document.getElementById('reply-original-message').textContent = query.message;
            document.getElementById('admin-reply').value = query.adminReply || '';
            
            document.getElementById('reply-modal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        
        // Close reply modal
        function closeReplyModal() {
            document.getElementById('reply-modal').classList.remove('show');
            document.body.style.overflow = 'auto';
            currentReplyQueryId = null;
        }
        
        // Send reply
        function sendReply() {
            const replyText = document.getElementById('admin-reply').value.trim();
            
            if (!replyText) {
                alert('Please enter a reply message');
                return;
            }
            
            if (!currentReplyQueryId) return;
            
            const queries = JSON.parse(localStorage.getItem('bumableContactQueries') || '[]');
            const queryIndex = queries.findIndex(q => q.id === currentReplyQueryId);
            
            if (queryIndex !== -1) {
                queries[queryIndex].adminReply = replyText;
                queries[queryIndex].status = 'replied';
                queries[queryIndex].replyTimestamp = new Date().toISOString();
                
                localStorage.setItem('bumableContactQueries', JSON.stringify(queries));
                
                // Create notification for user (simplified - in real app this would be sent via email)
                const notifications = JSON.parse(localStorage.getItem('userNotifications') || '[]');
                notifications.push({
                    id: 'NOT' + Date.now(),
                    email: queries[queryIndex].email,
                    message: `Reply to your contact query: ${replyText}`,
                    timestamp: new Date().toISOString(),
                    read: false
                });
                localStorage.setItem('userNotifications', JSON.stringify(notifications));
                
                closeReplyModal();
                loadContactQueries();
                updateQueriesStats(); // Update statistics after reply
                
                alert('Reply sent successfully!');
            }
        }
        
        // Delete query
        function deleteQuery(queryId) {
            if (!confirm('Are you sure you want to delete this query?')) return;
            
            let queries = JSON.parse(localStorage.getItem('bumableContactQueries') || '[]');
            queries = queries.filter(q => q.id !== queryId);
            localStorage.setItem('bumableContactQueries', JSON.stringify(queries));
            
            loadContactQueries();
        }
        
        // ===== STATUS POPUP FUNCTIONALITY =====
        
        let currentEditingOrderId = null;
        let selectedNewStatus = null;
        
        // Open status popup
        function openStatusPopup(orderId, currentStatus) {
            console.log('Opening status popup for order:', orderId, 'with status:', currentStatus);
            
            // Ensure orderId is valid
            if (!orderId || orderId === 'undefined' || orderId === 'null') {
                alert('Error: Invalid order ID');
                return;
            }
            
            currentEditingOrderId = orderId;
            selectedNewStatus = null;
            
            // Set popup content with null check
            document.getElementById('popupOrderId').textContent = orderId;
            document.getElementById('currentStatus').textContent = (currentStatus || 'PENDING').toUpperCase();
            
            // Reset status options
            document.querySelectorAll('.status-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Hide selected status and save button
            document.getElementById('selectedStatus').style.display = 'none';
            document.getElementById('saveStatusBtn').style.display = 'none';
            
            // Show popup
            document.getElementById('statusPopup').classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        
        // Close status popup
        function closeStatusPopup() {
            document.getElementById('statusPopup').classList.remove('show');
            document.body.style.overflow = 'auto';
            currentEditingOrderId = null;
            selectedNewStatus = null;
        }
        
        // Select new status (don't save immediately)
        function selectNewStatus(newStatus) {
            selectedNewStatus = newStatus;
            
            // Update visual selection
            document.querySelectorAll('.status-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector(`[data-status="${newStatus}"]`).classList.add('selected');
            
            // Show selected status
            document.getElementById('newStatusText').textContent = newStatus.toUpperCase();
            document.getElementById('selectedStatus').style.display = 'block';
            document.getElementById('saveStatusBtn').style.display = 'inline-block';
        }
        
        // Save order status
        function saveOrderStatus() {
            if (!currentEditingOrderId || !selectedNewStatus) {
                alert('Please select a status first');
                return;
            }
            
            console.log('Saving order status for:', currentEditingOrderId, 'to:', selectedNewStatus);
            
            try {
                // Get stored orders - try both possible keys
                let orders = JSON.parse(localStorage.getItem('bumableOrders')) || 
                            JSON.parse(localStorage.getItem('orders')) || [];
                
                console.log('Found orders:', orders.length);
                console.log('Looking for order ID:', currentEditingOrderId);
                
                // Find and update the order
                const orderIndex = orders.findIndex(order => order.orderId === currentEditingOrderId);
                console.log('Order index found:', orderIndex);
                
                if (orderIndex !== -1) {
                    const oldStatus = orders[orderIndex].status || 'pending';
                    orders[orderIndex].status = selectedNewStatus;
                    
                    // Save back to localStorage (use the same key that was found)
                    if (localStorage.getItem('bumableOrders')) {
                        localStorage.setItem('bumableOrders', JSON.stringify(orders));
                    } else {
                        localStorage.setItem('orders', JSON.stringify(orders));
                    }
                    
                    console.log('Order updated successfully');
                    
                    // Save order ID and status for message before closing popup
                    const orderIdForMessage = currentEditingOrderId;
                    const oldStatusText = (oldStatus || 'pending').toUpperCase();
                    const newStatusText = (selectedNewStatus || 'pending').toUpperCase();
                    
                    // Close popup
                    closeStatusPopup();
                    
                    // Refresh the orders display
                    if (typeof loadOrdersData === 'function') {
                        loadOrdersData();
                    } else if (typeof displayOrders === 'function') {
                        displayOrders();
                    }
                    
                    // Show success message with saved values
                    alert(`Order ${orderIdForMessage} status updated from "${oldStatusText}" to "${newStatusText}"`);
                } else {
                    console.error('Order not found in localStorage');
                    alert('Error: Order not found in database');
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                alert('Error updating order status: ' + error.message);
            }
        }
        
        // Helper function to get status class (keeping simple without colors)
        function getStatusClass(status) {
            return 'status-text';
        }
        
        // Close popup when clicking outside
        document.addEventListener('click', function(event) {
            const popup = document.getElementById('statusPopup');
            if (event.target === popup) {
                closeStatusPopup();
            }
        });
        
        // Close popup with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeStatusPopup();
            }
        });
        
        // ===== DELETE FUNCTIONALITY =====
        
        // Delete order function
        function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                return;
            }
            
            const orders = JSON.parse(localStorage.getItem('bumableOrders')) || [];
            const updatedOrders = orders.filter(order => order.orderId !== orderId);
            
            localStorage.setItem('bumableOrders', JSON.stringify(updatedOrders));
            
            // Refresh the orders display
            loadOrdersData();
            loadCustomersData(); // Also refresh customers as their totals might change
            
            alert('Order deleted successfully!');
        }
        
        // Delete customer function
        function deleteCustomer(customerId) {
            if (!confirm('Are you sure you want to delete this customer and ALL their orders? This action cannot be undone.')) {
                return;
            }
            
            const orders = JSON.parse(localStorage.getItem('bumableOrders')) || [];
            const updatedOrders = orders.filter(order => 
                (order.email || order.phone || order.orderId) !== customerId
            );
            
            localStorage.setItem('bumableOrders', JSON.stringify(updatedOrders));
            
            // Refresh both displays
            loadOrdersData();
            loadCustomersData();
            
            alert('Customer and all their orders deleted successfully!');
        }
        
        // ===== END CUSTOMER MANAGEMENT FUNCTIONS =====
        
        // Remove debug function
        // (Debug function removed as requested)
        
        // ===== END PRODUCT SYNCHRONIZATION FUNCTIONS =====
    </script>

    <!-- Status Update Popup Modal -->
    <div id="statusPopup" class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header">
                <h3><i class="fas fa-edit"></i> Update Order Status</h3>
                <button class="close-btn" onclick="closeStatusPopup()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="popup-body">
                <p><strong></strong>Order ID:</strong> <span id="popupOrderId"></span></p>
                <p><strong>Current Status:</strong> <span id="currentStatus"></span></p>
                
                <div class="status-options">
                    <label>Select New Status:</label>
                    <div class="status-grid">
                        <button class="status-option" data-status="confirmed" onclick="selectNewStatus('confirmed')">
                            <i class="fas fa-check"></i>
                            <span>Confirmed</span>
                        </button>
                        <button class="status-option" data-status="processing" onclick="selectNewStatus('processing')">
                            <i class="fas fa-cog"></i>
                            <span>Processing</span>
                        </button>
                        <button class="status-option" data-status="shipped" onclick="selectNewStatus('shipped')">
                            <i class="fas fa-truck"></i>
                            <span>Shipped</span>
                        </button>
                        <button class="status-option" data-status="delivered" onclick="selectNewStatus('delivered')">
                            <i class="fas fa-check-circle"></i>
                            <span>Delivered</span>
                        </button>
                        <button class="status-option status-danger" data-status="cancelled" onclick="selectNewStatus('cancelled')">
                            <i class="fas fa-times-circle"></i>
                            <span>Cancelled</span>
                        </button>
                    </div>
                </div>
                
                <div id="selectedStatus" class="selected-status" style="display: none;">
                    <p><strong>New Status:</strong> <span id="newStatusText"></span></p>
                </div>
            </div>
            <div class="popup-footer">
                <button class="btn-secondary" onclick="closeStatusPopup()">Cancel</button>
                <button id="saveStatusBtn" class="btn-primary" onclick="saveOrderStatus()" style="display: none;">Save Changes</button>
            </div>
        </div>
    </div>

</body>
</html>